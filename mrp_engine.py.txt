import pandas as pd
import datetime
from google.cloud import bigquery

def run_mrp():
    client = bigquery.Client(project="analytics-data-mty")

    query = """
   WITH BASE AS (
SELECT
t.*,
DATE_TRUNC(t.FECHA, WEEK(MONDAY)) AS LUNES_SEMANA,
CONCAT(
CAST(EXTRACT(ISOYEAR FROM t.FECHA) AS STRING),
LPAD(CAST(EXTRACT(ISOWEEK FROM t.FECHA) AS STRING), 2, '0')
) AS YEARWEEK
FROM `analytics-data-mty.MRP_AUTO.FCST_MRP_AUTO` t
WHERE FECHA BETWEEN DATE_TRUNC(CURRENT_DATE(), WEEK(MONDAY)) AND "2026-02-28"
AND SKU = 1995
AND WAREHOUSE = "MXCD02"
),

PROMEDIOS AS (
SELECT
b.CENTRO,
WAREHOUSE,
SKU,
DESCRIPCION,
AGRUPADOR,
LLAVE_FINAL,
YEARWEEK,
SEASON,
POLITICA_PEAK_DAYS,
POLITICA_OFF_PEAK_DAYS,
CUBICAJE_REQ,
TIPO_ENTREGA,
SUM(FCST_FINAL) AS FCST,
CAST((
SELECT AVG(IFNULL(t2.FCST_FINAL,0))
FROM `analytics-data-mty.MRP_AUTO.FCST_MRP_AUTO` t2
WHERE t2.WAREHOUSE = b.WAREHOUSE
AND t2.SKU = b.SKU
AND t2.FECHA BETWEEN b.LUNES_SEMANA AND DATE_ADD(b.LUNES_SEMANA, INTERVAL 27 DAY)
) AS INT64) AS PROMEDIO_4_SEMANAS
FROM BASE b
GROUP BY ALL
),

FCST_STOCK AS (
SELECT
A.*,
B.LIBRE_UTILIZACION AS STOCK_ACTUAL
FROM PROMEDIOS A
LEFT JOIN `analytics-data-mty.MRP.SAP_CLOUD_MB52` B
ON A.CENTRO = B.CENTRO AND A.SKU = B.SKU

)

SELECT
*,
CASE WHEN AGRUPADOR IN ("Corrugado Caja", "Playo", "Cinta Gorilla", "Cinta Transparente") THEN 2
ELSE 1 END AS LEAD_TIME
FROM FCST_STOCK
    """

    df = client.query(query).to_dataframe()
    df = df.sort_values(["SKU","WAREHOUSE","YEARWEEK"]).reset_index(drop=True)

    today = datetime.date.today()
    current_yw = f"{today.isocalendar().year}{today.isocalendar().week:02d}"
    current_yw_int = int(current_yw)

    result = []

    for (sku, wh), group in df.groupby(["SKU","WAREHOUSE"]):
        group = group.sort_values("YEARWEEK").reset_index(drop=True)
        stock = group.loc[0, "STOCK_ACTUAL"]

        first_order_week = current_yw_int + int(group.loc[0, "LEAD_TIME"])

        for _, row in group.iterrows():
            stock_ini = stock
            stock_fin_pre = stock_ini - row["FCST"]

            politica = (
                row["POLITICA_PEAK_DAYS"]
                if row["SEASON"] == "PEAK"
                else row["POLITICA_OFF_PEAK_DAYS"]
            )

            if row["TIPO_ENTREGA"] == "Semanal":
                politica += 3.5

            stock_obj = politica * row["PROMEDIO_4_SEMANAS"]

            if int(row["YEARWEEK"]) < first_order_week:
                req = 0
            else:
                req = max(stock_obj - stock_fin_pre, 0)

            stock = stock_fin_pre + req

            result.append({
                "SKU": row["SKU"],
                "WAREHOUSE": row["WAREHOUSE"],
                "YEARWEEK": row["YEARWEEK"],
                "PEDIDO": req,
                "STOCK_FIN": stock
            })

    return pd.DataFrame(result)
